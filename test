terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 6.0"
    }
  }
}
provider "aws" {
  region = "us-west-1"
  access_key = "AKIAZ3AKIAZ3MGNK624Z2QQMPT"
  secret_key = var.secret_key
}
resource "aws_vpc" "vpc_testing" {
    cidr_block = "10.0.0.0/24"
    enable_dns_hostnames = true
    enable_dns_support = true
    tags = {
      Name="vpc_testing"
    }
}
resource "aws_subnet" "pub_subnet1" {
    vpc_id = aws_vpc.vpc_testing.id
    cidr_block = "10.0.0.0/26"
    availability_zone = "us-west-1a"
    map_public_ip_on_launch = true
    tags = {
      Name="pub_subnet1"
    }
}
resource "aws_subnet" "pub_subnet2" {
    vpc_id = aws_vpc.vpc_testing.id
    cidr_block = "10.0.0.64/26"
    availability_zone = "us-west-1b"
    map_public_ip_on_launch = true
    tags = {
      Name="pub_subnet2"
    }
}
resource "aws_subnet" "private_subnet" {
    vpc_id = aws_vpc.vpc_testing.id
    cidr_block = "10.0.0.128/26"
    availability_zone = "us-west-1c"
    tags = {
      Name="private_subnet"
    }
}
resource "aws_internet_gateway" "testing_gateway" {
    vpc_id = aws_vpc.vpc_testing.id
    tags = {
      Name="testing_gateway"
    }
}
resource "aws_route_table" "testing_route_table" {
    vpc_id = aws_vpc.vpc_testing.id
    route {
      cidr_block = "0.0.0.0/0"
      gateway_id = aws_internet_gateway.testing_gateway.id
    }
}
resource "aws_route_table_association" "testing_route_table_association" {
    route_table_id = aws_route_table.testing_route_table.id
    subnet_id = aws_subnet.pub_subnet1.id
}
resource "aws_security_group" "load_balancer_sg" {
    name = "load_balancer-sg"
    description = "Security group for load balancer"
    vpc_id = aws_vpc.vpc_testing.id
    ingress {
      from_port = 80
      to_port = 80
      protocol = "tcp"
      cidr_blocks = ["0.0.0.0/0"]
    }
    egress  {
      from_port = 0
      to_port = 0
      protocol = "-1"
      cidr_blocks = ["0.0.0.0/0"]
    }
}
resource "aws_security_group" "ec2_sg" {
    name = "ec2-sg"
    vpc_id = aws_vpc.vpc_testing.id
    ingress {
      from_port = 80
      to_port = 80
      protocol = "tcp"
      security_groups = [aws_security_group.load_balancer_sg.id]
    }
    egress  {
      from_port = 0
      to_port = 0
      protocol = "-1"
      cidr_blocks = ["0.0.0.0/0"]
    }
}
resource "aws_security_group" "database_sg" {
    name = "database_sg"
    vpc_id = aws_vpc.vpc_testing.id
    ingress {
      from_port = 3306
      to_port = 3306
      protocol = "tcp"
      security_groups = [aws_security_group.ec2_sg.id]
    }
    egress {
        from_port = 3306
        to_port = 3306
        protocol = "-1"
        cidr_blocks = ["0.0.0.0/0"]
    }
}
